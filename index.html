<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Land Use Change Dashboard â€” Khartoum (GeoTIFF + Dynamic World)</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- html2canvas for snapshot -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- GeoTIFF support -->
<script src="https://unpkg.com/georaster"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

<style>
body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#0b1020; color:#e6e6ee; }
.card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.04); border-radius:12px; }
.btn { background: linear-gradient(90deg,#8b5cf6,#f973b2); color:white; padding:.5rem .9rem; border-radius:10px; font-weight:600; box-shadow:0 6px 18px rgba(139,92,246,0.12); }
#map { height:520px; border-radius:10px; overflow:hidden; }
.legend-swatch { width:18px; height:18px; display:inline-block; margin-left:8px; border-radius:4px; border:1px solid rgba(0,0,0,0.2); }
.small-input { background: #0f1724; border:1px solid rgba(255,255,255,0.06); color:#e6e6ee; padding:.35rem .5rem; border-radius:8px; width:320px; }
.status { font-size:12px; color:#cbd5e1; }
@media (max-width:900px) { #map { height:380px; } .small-input { width:100%; } }
</style>
</head>
<body class="p-6">

<div class="max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex items-center justify-between flex-wrap gap-3">
    <div>
      <h1 class="text-2xl font-bold text-white">Land Use Change Dashboard â€” Khartoum</h1>
      <p class="text-sm text-gray-300 mt-1">Ø¯Ù…Ø¬ GeoTIFF Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆDynamic World Tiles.</p>
    </div>
    <div class="flex gap-3 items-center">
      <input id="tileTemplateInput" class="small-input" placeholder="Dynamic World Tile URL" />
      <button id="forceAddBtn" class="btn">Ø£Ø¶Ù Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª Ø§Ù„Ø¢Ù†</button>
      <button id="updateBtn" class="btn">ğŸ” Check / Auto-add DW</button>
      <button id="downloadBtn" class="btn">â¬‡ï¸ Download Map</button>
      <a href="index.html" class="px-4 py-2 rounded-lg text-white/90 bg-gray-800 border border-gray-700">Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
    </div>
  </header>

  <!-- DW Status -->
  <div class="text-sm status" id="dwStatus">Ø­Ø§Ù„Ø© DW: Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...</div>

  <!-- Main -->
  <main class="grid grid-cols-12 gap-6">

    <!-- Map -->
    <section class="col-span-12 lg:col-span-7 card p-4">
      <h2 class="text-white font-semibold mb-3">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
      <div id="map"></div>
      <div class="mt-3 text-sm text-gray-300">
        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§ÙØªØ­ÙŠ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ù„ØªØ¬Ù†Ù‘Ø¨ Ù‚ÙŠÙˆØ¯ CORS Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª Ø£Ùˆ GeoTIFF.
      </div>
    </section>

    <!-- Sidebar -->
    <aside class="col-span-12 lg:col-span-5 space-y-4">

      <!-- Summary -->
      <div class="card p-4">
        <h3 class="font-semibold text-white mb-3">Summary</h3>
        <div id="summaryText" class="text-gray-200 text-sm leading-relaxed">Loading summary...</div>
        <div class="mt-4 text-xs text-gray-400">Ø§Ù„Ù…ØµØ¯Ø±: GeoTIFF / Dynamic World / Ø£Ù…Ø«Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©.</div>
      </div>

      <!-- Comparison Chart -->
      <div class="card p-4">
        <h3 class="font-semibold text-white mb-3">Comparison Chart (2023 vs 2025)</h3>
        <canvas id="compareChart" height="220"></canvas>
      </div>

      <!-- Legend -->
      <div class="card p-4">
        <h3 class="font-semibold text-white mb-3">Legend</h3>
        <div class="text-sm text-gray-200">
          <div><span class="legend-swatch" style="background:#1f78b4"></span> Water</div>
          <div><span class="legend-swatch" style="background:#33a02c"></span> Vegetation</div>
          <div><span class="legend-swatch" style="background:#e31a1c"></span> Urban</div>
          <div><span class="legend-swatch" style="background:#ff7f00"></span> Bare / Other</div>
        </div>
      </div>

    </aside>
  </main>

  <!-- Footer -->
  <footer class="text-xs text-gray-400 text-center mt-6">
    Built for <strong>Asia Hamdi</strong>.
  </footer>
  <div class="text-xs text-gray-500 text-center mt-1">
    Map data: <a href="https://developers.google.com/earth-engine/datasets/catalog/GOOGLE_DYNAMICWORLD_V1" target="_blank" class="underline">Google Dynamic World</a>
  </div>
</div>

<script>
// =================== Map ===================
const map = L.map('map', { center:[15.5007,32.5599], zoom:10, preferCanvas:true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', { attribution:'&copy; CartoDB', maxZoom:19 }).addTo(map);

// =================== Colors ===================
const classColors = { "Water":"#1f78b4", "Vegetation":"#33a02c", "Urban":"#e31a1c", "Bare":"#ff7f00" };

// =================== Chart ===================
const ctx = document.getElementById('compareChart').getContext('2d');
let compareChart = new Chart(ctx, {
  type:'bar',
  data:{
    labels:['Water','Vegetation','Urban','Bare'],
    datasets:[
      { label:'2023', data:[0,0,0,0], backgroundColor:['#1f78b4','#33a02c','#e31a1c','#ff7f00'], borderRadius:6 },
      { label:'2025', data:[0,0,0,0], backgroundColor:['rgba(31,120,180,0.6)','rgba(51,160,44,0.6)','rgba(227,26,28,0.6)','rgba(255,127,0,0.6)'], borderRadius:6 }
    ]
  },
  options:{
    responsive:true,
    plugins:{ legend:{ labels:{ color:'#e6e6ee' } } },
    scales:{ x:{ ticks:{ color:'#e6e6ee' } }, y:{ ticks:{ color:'#e6e6ee' }, beginAtZero:true } }
  }
});

// =================== Summary ===================
function updateSummary(p2023, p2025){
  const diff=p2025.map((v,i)=> (v-p2023[i]).toFixed(1));
  const labels=['Water','Vegetation','Urban','Bare'];
  document.getElementById('summaryText').innerHTML = labels.map((lab,i)=>`<div><strong>${lab}:</strong> ${p2023[i]}% â†’ ${p2025[i]}% &nbsp; <span style="color:${diff[i]>=0? '#4ade80':'#fb7185'}">(${diff[i]>=0?'+':''}${diff[i]}%)</span></div>`).join('');
}

// =================== Dynamic World Tiles ===================
const DEFAULT_DW = 'https://storage.googleapis.com/dynamicworld-data/styles/v1/visual/{z}/{x}/{y}.png';
const statusEl = document.getElementById('dwStatus');
document.getElementById('tileTemplateInput').value = DEFAULT_DW;

function addDynamicWorld(tileTemplate, year=2025){
  const tpl = tileTemplate.includes('{year}') ? tileTemplate.replace('{year}', year) : tileTemplate;
  if(window.dwLayer) try{ map.removeLayer(window.dwLayer); }catch(e){}
  
  window.dwLayer = L.tileLayer(tpl, {
    maxZoom:19,
    opacity:0.85,
    attribution:'&copy; <a href="https://earthengine.google.com/datasets/catalog/GOOGLE_DYNAMICWORLD_V1" target="_blank">Google Dynamic World</a>',
    crossOrigin:true,
    errorTileUrl:''
  });

  let tileErrors=0, tileLoads=0;
  dwLayer.on('tileload', ()=>{ tileLoads++; evaluate(); });
  dwLayer.on('tileerror', ()=>{ tileErrors++; evaluate(); });

  map.addLayer(dwLayer);
  setTimeout(()=>evaluate(true), 2500);

  function evaluate(force=false){
    if(tileLoads>0){ statusEl.textContent='Ø­Ø§Ù„Ø© DW: Ø¨Ù„Ø§Ø·Ø§Øª Dynamic World Ù…ÙØ¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­.'; statusEl.style.color='#86efac'; return; }
    if(force && tileLoads===0){ 
      statusEl.textContent='Ø­Ø§Ù„Ø© DW: ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ DW (CORS Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­Ø©).'; statusEl.style.color='#fda4af'; 
      try{ map.removeLayer(dwLayer); }catch(e){}
    } else statusEl.textContent='Ø­Ø§Ù„Ø© DW: Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...'; statusEl.style.color='#cbd5e1';
  }
}

// Buttons
document.getElementById('forceAddBtn').addEventListener('click', ()=>{ addDynamicWorld(document.getElementById('tileTemplateInput').value); });
document.getElementById('updateBtn').addEventListener('click', ()=>{ addDynamicWorld(DEFAULT_DW); });

// Auto-add DW on load
addDynamicWorld(DEFAULT_DW);

// =================== GeoTIFF Layers ===================
async function addGeoTIFFLayer(filePath){
  const response = await fetch(filePath);
  const arrayBuffer = await response.arrayBuffer();
  const georaster = await parseGeoraster(arrayBuffer);

  const layer = new GeoRasterLayer({
    georaster,
    opacity:0.6,
    pixelValuesToColorFn: function(pixel){
      if(pixel===1) return classColors["Water"];
      if(pixel===2) return classColors["Vegetation"];
      if(pixel===3) return classColors["Urban"];
      if(pixel===4) return classColors["Bare"];
      return null;
    },
    resolution:256
  });

  layer.addTo(map);
  return layer;
}

// Load layers and update chart/summary
(async function(){
  const layer2023 = await addGeoTIFFLayer('data/LULC_Khartoum_2023.tif');
  const layer2025 = await addGeoTIFFLayer('data/LULC_Khartoum_2025.tif');

  // Layer switch control
  L.control.layers(null, {
    "LULC 2023": layer2023,
    "LULC 2025": layer2025,
    "Dynamic World": window.dwLayer
  }, {collapsed:false, position:'topright'}).addTo(map);

  // Ù…Ø«Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ© Ù„Ù„Ù†Ø³Ø¨
  const p2023=[10,40,30,20];
  const p2025=[8,35,36,21];
  updateSummary(p2023,p2025);
  compareChart.data.datasets[0].data=p2023;
  compareChart.data.datasets[1].data=p2025;
  compareChart.update();
})();

// =================== Download Snapshot ===================
document.getElementById('downloadBtn').addEventListener('click', async function(){
  const el = document.querySelector('.max-w-6xl');
  this.textContent = '...Preparing';
  try{
    const canvas = await html2canvas(el, { useCORS:true, allowTaint:true, scale:1.6 });
    const dataURL = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = dataURL; a.download='landuse-dashboard-khartoum.png'; document.body.appendChild(a); a.click(); a.remove();
    this.textContent = 'â¬‡ï¸ Download Map';
  } catch(e){
    console.error(e); alert('Download failed. Ø§ÙØªØ­ÙŠ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø±Ø§Ø¬Ø¹ÙŠ CORS.'); this.textContent = 'â¬‡ï¸ Download Map';
  }
});
</script>
</body>
</html>

